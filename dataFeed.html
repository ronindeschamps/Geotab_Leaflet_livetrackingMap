<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Geotab SDK | Data Feed Example</title>
    <link rel="icon" href="../../favicon.ico">
    <!-- Updated CSS file to reflect the UI refresh -->
    <link href="css/JavaScriptExamples.css" rel="stylesheet" type="text/css" />
    <!-- Materialize icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--leaflet css for map-->
    <link rel="stylesheet" href="/leaflet/leaflet.css" />
    <script src="/path/to/leaflet.js"></script>
</head>

<body>
    <!-- Contains all of the elements within the nav bar (logo, sample-pill, sign-out button) -->

    <header>
        <nav>
            <!-- Sign out button using the CSS class "primary-btn" to apply the primary button stylings -->
            <button class="primary-btn sign-out-btn" id="signout">Sign out</button>
        </nav>
    </header>

    <div class="container">
        <!-- Div used to append the sign in components too within loginUpdated.js -->
        <div id="signin-content"></div>


        <!-- Components which make up the example in this case input fields to select the data to be retrieved -->
        <div id="example-content">
            <form>
                <p>
                    Select the options of data you want to visualize:
                </p>
                <p>
                    <input id="includeLocationData" type="checkbox" checked="checked" /> <label for="includeLocationData">Include location data</label>
                </p>
                <p>
                    <input id="includeStatusData" type="checkbox" checked="checked" /> <label for="includeStatusData">Include engine status data</label>
                </p>
                <p>
                    <input id="includeFaultData" type="checkbox" checked="checked" /> <label for="includeFaultData">Include vehicle fault data</label>
                </p>
                <button class="primary-btn" id="toggleFeed">Start data feed</button>&nbsp;<button class="secondary-btn" id="clear">Clear</button>
            </form>
        </div>

        <div id="feed-container" class="feed-container">
            <table>
                <thead>
                    <tr>
                        <th>Vehicle Id</th>
                        <th>Id</th>
                        <th>Date</th>
                        <th>Latitude</th>
                        <th>Longitude</th>
                        <th>Speed</th>
                        <th>Diagnostic</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody id="feed"></tbody>
            </table>
        </div>
    </div>

    <!-- JavaScript file containing the api functionality -->
    <script src="api.js"></script>

    <!-- JavaScript file containing the login functionality (creating the sign-in modal) -->
    <script src="login.js"></script>

    <!-- The JavaScript used for the example is present in the same HTML file here -->
    <script type="text/javascript">var table;
            var enabled = false;
            var updateInterval = 5; // In seconds
            var update = null;
            var lastVersions = [ null, null, null ];
            var startDate = new Date(new Date().setUTCHours(0,0,0,0) - 24*60*60*1000).toISOString();

            document.addEventListener("DOMContentLoaded", function() {

                table = document.getElementById("feed");

                document.getElementById("toggleFeed").addEventListener("click", function(event) {
                    event.preventDefault();

                    enabled = !enabled;
                    event.target.innerHTML = enabled ? "Stop data feed" : "Start data feed";

                    if (enabled) {
                        document.getElementById("feed-container").setAttribute("style", "display:block;");
                        pollForData(); // This ensures it starts right away
                        update = setInterval(pollForData, 1000 * updateInterval);
                    } else {
                        if (update) {
                            clearInterval(update);
                            lastVersions = [null, null, null];
                        }
                    }
                });

                document.getElementById("clear").addEventListener("click", function(event) {
                    event.preventDefault();

                    table.innerHTML = "";
                });

            });

            function pollForData() {
                var includeLocationData = document.getElementById("includeLocationData").checked;
                var includeStatusData = document.getElementById("includeStatusData").checked;
                var includeFaultData = document.getElementById("includeFaultData").checked;

                if (!includeLocationData && !includeStatusData && !includeFaultData) {
                    document.getElementById("includeLocationData").checked = true;
                }

                var apiCalls = [];

                if (includeLocationData) {
                    apiCalls.push(["GetFeed", {
                        "typeName": "LogRecord",
                        "fromVersion": lastVersions[0],
                        "search": {
                            "fromDate": startDate
                        },
                        "resultsLimit": 1000,
                    }]);
                }

                if (includeStatusData) {
                    apiCalls.push(["GetFeed", {
                        "typeName": "StatusData",
                        "fromVersion": lastVersions[1],
                        "search": {
                            "fromDate": startDate
                        },
                        "resultsLimit": 1000,
                    }]);
                }

                if (includeFaultData) {
                    apiCalls.push(["GetFeed", {
                        "typeName": "FaultData",
                        "fromVersion": lastVersions[2],
                        "search": {
                            "fromDate": startDate
                        },
                        "resultsLimit": 1000,
                    }]);
                }

                api.multiCall(apiCalls, function(result) {
                    if (result !== undefined && result.length > 0) {
                        for (var i = 0; i < result.length; i++) {
                            displayFeed(result[i]);
                            lastVersions[i] = result[i].toVersion;
                        }
                    }
                }, function(error) {
                    console.log(error);
                });
            }

            function displayFeed(feed) {
                if (feed.data !== undefined && feed.data.length > 0) {
                    for (var i = 0; i < feed.data.length; i++) {
                        var row = null,
                        	feedData = feed.data[i];
                        if (feedData.hasOwnProperty("data") || feedData.hasOwnProperty("failureMode")) {
                            row = createEngineRow(feedData);
                        } else {
                            row = createLocationRow(feedData);
                        }
                        table.appendChild(row);
                    }
                }
            }

            function createLocationRow(feedItem) {
                var row = document.createElement("tr");
                row.appendChild(createCell(feedItem.device.id));
                row.appendChild(createCell(feedItem.id));
                row.appendChild(createCell(feedItem.dateTime));
                row.appendChild(createCell(feedItem.latitude));
                row.appendChild(createCell(feedItem.longitude));
                row.appendChild(createCell(feedItem.speed));
                row.appendChild(createCell("-"));
                row.appendChild(createCell("-"));
                return row;
            }

            function createEngineRow(feedItem) {
                var row = document.createElement("tr");
                row.appendChild(createCell(feedItem.device.id));
                row.appendChild(createCell(feedItem.id));
                row.appendChild(createCell(feedItem.dateTime));
                row.appendChild(createCell("-"));
                row.appendChild(createCell("-"));
                row.appendChild(createCell("-"));
                row.appendChild(createCell(feedItem.diagnostic.id.replace("Diagnostic", "").replace("Id", "")));
                row.appendChild(createCell(feedItem.data || "-"));
                return row;
            }

            function createCell(text) {
                var cell = document.createElement("td");
                var textNode = document.createTextNode(text);
                cell.appendChild(textNode);
                return cell;
            }</script>

</body>

</html>
